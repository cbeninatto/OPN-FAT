<!-- test.html | v1.5 | Faturamento + Volume Metrics, Categorical Axis, Period Filters -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VisÃ£o Geral â€“ Faturamento e Volume</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#dfe1e1;--card:#fff;--gold:#f5b95f;
  --ink:#1f2937;--muted:#6b7280;--red:#e53935;--blue:#1e88e5
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Inter,system-ui;color:var(--ink)}
.wrap{max-width:1100px;margin:40px auto;background:var(--card);
  padding:24px;border-radius:16px;box-shadow:0 6px 26px rgba(16,24,40,.08)}
h2{margin:0 0 14px;font-weight:700}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:16px}
.btn{border:1px solid #e5e7eb;background:#fff;padding:7px 12px;
  border-radius:10px;cursor:pointer;font-weight:600;color:var(--ink)}
.btn.active{background:var(--ink);color:#fff;border-color:var(--ink)}
.period{display:flex;gap:6px;align-items:center;margin-left:auto}
select{border:1px solid #e5e7eb;border-radius:8px;padding:6px 8px;background:#fff}
#chart{width:100%;height:560px}
#loading{position:fixed;inset:0;background:rgba(255,255,255,.9);
  display:flex;align-items:center;justify-content:center;font-weight:700;z-index:10}
#loading.hidden{opacity:0;pointer-events:none;transition:opacity .3s}
.statsGrid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:24px 0}
.group{border-radius:12px;background:#fff;border:2px solid var(--gold);padding:14px}
.group h3{margin:0 0 10px;font-size:16px;font-weight:700;color:var(--ink);
  display:flex;align-items:center;gap:6px}
.metric{display:flex;justify-content:space-between;margin:4px 0;font-size:15px}
.metric span{font-weight:600}
pre{white-space:pre-wrap;background:#fafafa;border:1px dashed #e5e7eb;
  padding:8px;border-radius:8px;color:#475569;font-size:12px}
</style>
</head>
<body>
<div id="loading">Carregando dadosâ€¦</div>
<div class="wrap">
  <h2>ðŸ“Š VisÃ£o Geral â€” Faturamento & Volume</h2>

  <!-- Filtros -->
  <div class="toolbar">
    <button class="btn" data-window="3M">3M</button>
    <button class="btn" data-window="6M">6M</button>
    <button class="btn" data-window="1A">1A</button>
    <button class="btn" data-window="5A">5A</button>
    <button class="btn active" data-window="TUDO">Tudo</button>
    <div class="period">
      <label for="startSel">PerÃ­odo:</label>
      <select id="startSel"></select>
      <span>â€”</span>
      <select id="endSel"></select>
      <button class="btn" id="applyRange">Aplicar</button>
    </div>
  </div>

  <div id="chart"></div>

  <!-- Indicadores -->
  <div class="statsGrid">
    <div class="group" id="fatBlock">
      <h3>ðŸ’° Faturamento</h3>
      <div class="metric"><span>MÃ©dia Mensal:</span> <span id="fatMedia">â€”</span></div>
      <div class="metric"><span>VariaÃ§Ã£o Total:</span> <span id="fatVar">â€”</span></div>
      <div class="metric"><span>Volatilidade:</span> <span id="fatVol">â€”</span></div>
    </div>
    <div class="group" id="volBlock">
      <h3>ðŸ“¦ Volume</h3>
      <div class="metric"><span>MÃ©dia Mensal:</span> <span id="volMedia">â€”</span></div>
      <div class="metric"><span>VariaÃ§Ã£o Total:</span> <span id="volVar">â€”</span></div>
      <div class="metric"><span>Volatilidade:</span> <span id="volVol">â€”</span></div>
    </div>
  </div>

  <pre id="debug"></pre>
</div>

<script>
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
const keyYM=(y,m)=>`${y}-${String(m).padStart(2,"0")}`;
const labelYM=(y,m)=>`${PT_ABBR[m-1]} ${String(y).slice(-2)}`;

function fmtBRL(v){return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});}
function fmtInt(v){return Math.round(v).toLocaleString("pt-BR");}
function pct(v){return (isFinite(v)?v:0).toFixed(1).replace(".",",")+"%";}

/* ---- NormalizaÃ§Ã£o CSV ---- */
function normalizeRows(rows){
  const map=new Map();
  for(const r of rows){
    const ano=Number(r.Ano), mes=Number(r.Mes);
    const fat=Number(r.Valor)||0, vol=Number(r.Quantidade)||0;
    if(!ano||!mes) continue;
    const key=keyYM(ano,mes);
    if(!map.has(key)) map.set(key,{Key:key,Ano:ano,Mes:mes,Faturamento:0,Volume:0});
    const m=map.get(key);
    m.Faturamento+=fat; m.Volume+=vol;
  }
  return [...map.values()].sort((a,b)=>a.Key.localeCompare(b.Key));
}

/* ---- EstatÃ­sticas ---- */
function calcStats(arr){
  if(arr.length<1) return {media:0,varTotal:0,volatilidade:0};
  const media=arr.reduce((a,b)=>a+b,0)/arr.length;
  if(arr.length<2) return {media,varTotal:0,volatilidade:0};
  const pct=[]; for(let i=1;i<arr.length;i++){const v0=arr[i-1]; if(v0) pct.push((arr[i]/v0-1)*100);}
  const varTotal=(arr.at(-1)/arr[0]-1)*100;
  const avg=pct.reduce((a,b)=>a+b,0)/(pct.length||1);
  const vol=Math.sqrt(pct.reduce((a,b)=>a+(b-avg)**2,0)/Math.max(1,pct.length-1));
  return {media,varTotal,volatilidade:vol};
}

/* ---- Filtros ---- */
function populateSelects(monthly){
  const s=document.getElementById("startSel"), e=document.getElementById("endSel");
  s.innerHTML=""; e.innerHTML="";
  for(const m of monthly){
    const opt=document.createElement("option");
    opt.value=m.Key; opt.textContent=labelYM(m.Ano,m.Mes);
    s.appendChild(opt.cloneNode(true)); e.appendChild(opt);
  }
  s.value=monthly[0].Key; e.value=monthly.at(-1).Key;
}
function sliceLast(arr,n){return arr.slice(-n);}
function filterRange(arr,s,e){return arr.filter(m=>m.Key>=s&&m.Key<=e);}

/* ---- Plotly ---- */
function drawChart(monthly){
  const x=monthly.map(m=>m.Key);
  const ticks=monthly.map(m=>labelYM(m.Ano,m.Mes));
  const bars={
    x, y:monthly.map(m=>m.Faturamento), type:'bar',
    marker:{color:'var(--red)',opacity:0.9}, name:'Faturamento (R$)',
    hovertemplate:"<b>%{customdata.label}</b><br>Faturamento: %{customdata.fat}<br>Volume: %{customdata.vol}<extra></extra>",
    customdata:monthly.map(m=>({label:labelYM(m.Ano,m.Mes),fat:fmtBRL(m.Faturamento),vol:fmtInt(m.Volume)}))
  };
  const line={
    x, y:monthly.map(m=>m.Volume), mode:'lines+markers',
    line:{shape:'spline',width:3,color:'var(--blue)',smoothing:0.6},
    marker:{size:6,line:{width:1,color:'#fff'}}, name:'Volume (un.)', yaxis:'y2'
  };
  Plotly.react("chart",[bars,line],{
    hovermode:'x unified',
    xaxis:{type:'category',categoryorder:'array',categoryarray:x,tickmode:'array',tickvals:x,ticktext:ticks,showgrid:false},
    yaxis:{title:'Faturamento (R$)',gridcolor:'#e9ecef',autorange:true},
    yaxis2:{title:'Volume (un.)',overlaying:'y',side:'right',autorange:true},
    legend:{orientation:'h',y:-0.25},
    paper_bgcolor:'#fff',plot_bgcolor:'#fff',margin:{t:30,r:50,b:80,l:64}
  },{responsive:true});
}

/* ---- Atualiza blocos ---- */
function updateBlocks(monthly){
  const fat=monthly.map(m=>m.Faturamento), vol=monthly.map(m=>m.Volume);
  const sF=calcStats(fat), sV=calcStats(vol);
  document.getElementById("fatMedia").textContent=fmtBRL(sF.media);
  document.getElementById("fatVar").textContent=pct(sF.varTotal);
  document.getElementById("fatVol").textContent=pct(sF.volatilidade);
  document.getElementById("volMedia").textContent=fmtInt(sV.media);
  document.getElementById("volVar").textContent=pct(sV.varTotal);
  document.getElementById("volVol").textContent=pct(sV.volatilidade);
}

/* ---- Estado e interaÃ§Ãµes ---- */
let ALL=[];
function applyWindow(tag){
  document.querySelectorAll(".btn[data-window]").forEach(b=>b.classList.toggle("active",b.dataset.window===tag));
  let subset=[];
  switch(tag){
    case"3M":subset=sliceLast(ALL,3);break;
    case"6M":subset=sliceLast(ALL,6);break;
    case"1A":subset=sliceLast(ALL,12);break;
    case"5A":subset=sliceLast(ALL,60);break;
    default:subset=[...ALL];
  }
  const s=document.getElementById("startSel"), e=document.getElementById("endSel");
  if(subset.length){s.value=subset[0].Key; e.value=subset.at(-1).Key;}
  drawChart(subset); updateBlocks(subset);
}
function applyRange(){
  const s=document.getElementById("startSel").value, e=document.getElementById("endSel").value;
  const range=filterRange(ALL, s>e?e:s, s>e?s:e);
  document.querySelectorAll(".btn[data-window]").forEach(b=>b.classList.remove("active"));
  drawChart(range); updateBlocks(range);
}

/* ---- Main ---- */
(async()=>{
  try{
    const res=await fetch("data/relatorio_faturamento.csv?cb="+Date.now());
    const txt=await res.text();
    const delim=txt.includes(";")?";":",";
    const parsed=Papa.parse(txt,{header:true,skipEmptyLines:true,delimiter:delim});
    ALL=normalizeRows(parsed.data);
    populateSelects(ALL);
    drawChart(ALL); updateBlocks(ALL);
    document.querySelectorAll(".btn[data-window]").forEach(b=>b.onclick=()=>applyWindow(b.dataset.window));
    document.getElementById("applyRange").onclick=applyRange;
    document.getElementById("debug").textContent="Linhas processadas: "+ALL.length;
  }catch(err){
    document.getElementById("debug").textContent="Erro: "+err;
  }finally{
    document.getElementById("loading").classList.add("hidden");
  }
})();
</script>
</body>
</html>
