<!-- test.html | v1.4 | CategÃ³rico + Indicadores + Filtros 3M/6M/1A/5A/Tudo + PerÃ­odo manual -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teste - VisÃ£o Geral (Filtros de PerÃ­odo)</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#dfe1e1;--card:#fff;--red:#e53935;--blue:#1e88e5;--ink:#1f2937;--muted:#6b7280;--gold:#f5b95f}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:Inter,system-ui;color:var(--ink)}
  .wrap{max-width:1100px;margin:36px auto;background:var(--card);padding:22px;border-radius:14px;box-shadow:0 6px 26px rgba(16,24,40,.08)}
  h2{margin:0 0 14px 0}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0 16px}
  .btn{appearance:none;border:1px solid #e5e7eb;background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.active{background:var(--ink);color:#fff;border-color:var(--ink)}
  .btn:hover{border-color:#d1d5db}
  .period{display:flex;gap:8px;align-items:center;margin-left:auto}
  select{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff}
  label{font-size:14px;color:var(--muted)}
  #chart{width:100%;height:560px}
  #loading{position:fixed;inset:0;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;font-weight:700;z-index:10}
  #loading.hidden{opacity:0;pointer-events:none;transition:opacity .3s}
  #stats{margin:18px 0 8px;display:flex;gap:14px;flex-wrap:wrap}
  #stats .card{background:#fafafa;border:1px solid #eee;border-radius:12px;padding:10px 14px;min-width:180px}
  #stats .title{font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px}
  #stats .value{font-size:18px;font-weight:700;color:#0f172a}
  .legend{font-size:12px;color:#64748b;margin:8px 0}
  pre{white-space:pre-wrap;background:#fff;border:1px dashed #e5e7eb;padding:8px;border-radius:10px;color:#475569}
</style>
</head>
<body>
<div id="loading">Carregando dadosâ€¦</div>
<div class="wrap">
  <h2>ðŸ“Š VisÃ£o Geral â€” Valor & Quantidade</h2>

  <!-- Filtros de perÃ­odo -->
  <div class="toolbar">
    <button class="btn" data-window="3M">3M</button>
    <button class="btn" data-window="6M">6M</button>
    <button class="btn" data-window="1A">1A</button>
    <button class="btn" data-window="5A">5A</button>
    <button class="btn active" data-window="TUDO">Tudo</button>
    <div class="period">
      <label for="startSel">PerÃ­odo:</label>
      <select id="startSel"></select>
      <span>â€”</span>
      <select id="endSel"></select>
      <button class="btn" id="applyRange">Aplicar</button>
    </div>
  </div>

  <div id="chart"></div>

  <!-- Indicadores -->
  <div id="stats">
    <div class="card">
      <div class="title">VariaÃ§Ã£o Total</div>
      <div class="value" id="varTotal">â€”</div>
    </div>
    <div class="card">
      <div class="title">MÃ©dia Mensal</div>
      <div class="value" id="avgMensal">â€”</div>
    </div>
    <div class="card">
      <div class="title">Volatilidade</div>
      <div class="value" id="volatilidade">â€”</div>
    </div>
  </div>

  <div class="legend">Fonte: <code>data/relatorio_faturamento.csv</code> | Colunas esperadas: <code>Codigo, Descricao, Quantidade, Valor, Mes, Ano</code></div>

  <h3>Debug</h3>
  <pre id="debug"></pre>
</div>

<script>
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];

/* -------------------- Helpers -------------------- */
const keyFromYM=(y,m)=>`${y}-${String(m).padStart(2,"0")}`;
const labelFromYM=(y,m)=>`${PT_ABBR[m-1]} ${String(y).slice(-2)}`;

function fmtBRL(v){ return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }
function fmtInt(v){ return Math.round(v).toLocaleString("pt-BR"); }
function pctStr(v){ return (isFinite(v)? v : 0).toFixed(2).replace(".",",")+"%"; }

/* -------------------- CSV normalization -------------------- */
/* CSV esperado: Codigo, Descricao, Quantidade, Valor, Mes, Ano */
function normalizeRows(rows){
  const out=[];
  for(const r of rows){
    const ano=Number(r.Ano), mes=Number(r.Mes);
    const valor=Number(r.Valor)||0;
    const qtd=Number(r.Quantidade)||0;
    if(!Number.isFinite(ano) || !Number.isFinite(mes) || mes<1 || mes>12) continue;
    out.push({Ano:ano,Mes:mes,Valor:valor,Quantidade:qtd,Key:keyFromYM(ano,mes)});
  }
  // agrega por Key (somando tudo que vier de cÃ³digos/descriÃ§Ãµes no mÃªs)
  const map=new Map();
  for(const x of out){
    if(!map.has(x.Key)) map.set(x.Key,{Key:x.Key,Ano:x.Ano,Mes:x.Mes,Valor:0,Quantidade:0});
    const m=map.get(x.Key);
    m.Valor+=x.Valor;
    m.Quantidade+=x.Quantidade;
  }
  const monthly=[...map.values()].sort((a,b)=>a.Key.localeCompare(b.Key));
  return monthly;
}

/* -------------------- Stats como no v5.3.2 -------------------- */
function calcStats(values){
  if(values.length<2) return {varTotal:0,avgMensal:0,volatilidade:0};
  const pct=[];
  for(let i=1;i<values.length;i++){
    const v0=values[i-1], v1=values[i];
    if(v0!==0) pct.push((v1/v0-1)*100);
  }
  const varTotal=(values.at(-1)/values[0]-1)*100;
  const avgMensal=pct.reduce((a,b)=>a+b,0)/(pct.length||1);
  const mean=avgMensal;
  const volatilidade=Math.sqrt(pct.reduce((a,b)=>a+(b-mean)**2,0)/Math.max(1,(pct.length-1)));
  return {varTotal,avgMensal,volatilidade};
}

/* -------------------- Filtro por janela/intervalo -------------------- */
function sliceLast(monthly, n){
  if(n<=0) return [];
  return monthly.slice(-n);
}
function filterRange(monthly, startKey, endKey){
  return monthly.filter(m=> m.Key>=startKey && m.Key<=endKey);
}

/* -------------------- UI: popula selects de perÃ­odo -------------------- */
function populatePeriodSelects(monthly){
  const startSel=document.getElementById('startSel');
  const endSel=document.getElementById('endSel');
  startSel.innerHTML=""; endSel.innerHTML="";
  for(const m of monthly){
    const opt1=document.createElement('option');
    opt1.value=m.Key; opt1.textContent=labelFromYM(m.Ano,m.Mes);
    const opt2=opt1.cloneNode(true);
    startSel.appendChild(opt1);
    endSel.appendChild(opt2);
  }
  // padrÃ£o = Tudo
  if(monthly.length){
    startSel.value=monthly[0].Key;
    endSel.value=monthly.at(-1).Key;
  }
}

/* -------------------- Desenho do grÃ¡fico -------------------- */
function drawChart(monthly){
  const x=monthly.map(m=>m.Key);
  const ticktext=monthly.map(m=>labelFromYM(m.Ano,m.Mes));

  const barsValor={
    x, y: monthly.map(m=>m.Valor),
    type:'bar',
    marker:{color:'var(--red)',opacity:0.9},
    name:'Valor (R$)',
    hovertemplate:"<b>%{customdata.l}</b><br>Valor: %{customdata.v}<extra></extra>",
    customdata: monthly.map(m=>({l:labelFromYM(m.Ano,m.Mes), v:fmtBRL(m.Valor)}))
  };

  const lineQtd={
    x, y: monthly.map(m=>m.Quantidade),
    mode:'lines+markers',
    line:{shape:'spline',width:3,color:'var(--blue)',smoothing:0.6},
    marker:{size:6,line:{width:1,color:'#fff'}},
    name:'Quantidade (un.)',
    yaxis:'y2',
    hovertemplate:"<b>%{customdata.l}</b><br>Quantidade: %{customdata.q} un<extra></extra>",
    customdata: monthly.map(m=>({l:labelFromYM(m.Ano,m.Mes), q:fmtInt(m.Quantidade)}))
  };

  const layout={
    hovermode:'x unified',
    xaxis:{
      type:'category',
      categoryorder:'array',
      categoryarray:x,
      tickmode:'array',
      tickvals:x,
      ticktext:ticktext,
      showgrid:false
    },
    yaxis:{title:'Valor (R$)',gridcolor:'#e9ecef',autorange:true},
    yaxis2:{title:'Quantidade (un.)',overlaying:'y',side:'right',autorange:true},
    legend:{orientation:'h',y:-0.22},
    paper_bgcolor:'#fff',
    plot_bgcolor:'#fff',
    margin:{t:30,r:50,b:80,l:64}
  };

  // autoscale garantido ao redesenhar
  Plotly.react('chart',[barsValor,lineQtd],layout,{responsive:true});
}

/* -------------------- Atualiza indicadores -------------------- */
function updateStats(monthly){
  const v=monthly.map(m=>m.Valor);
  const s=calcStats(v);
  document.getElementById('varTotal').textContent=pctStr(s.varTotal);
  document.getElementById('avgMensal').textContent=pctStr(s.avgMensal);
  document.getElementById('volatilidade').textContent=pctStr(s.volatilidade);
}

/* -------------------- Estado / InteraÃ§Ãµes -------------------- */
let ALL_MONTHLY=[]; // dataset completo (agregado por mÃªs)

function applyWindow(windowTag){
  // marca botÃ£o ativo
  document.querySelectorAll('.btn[data-window]').forEach(b=>b.classList.toggle('active', b.dataset.window===windowTag));
  let slice=[];
  switch(windowTag){
    case '3M': slice=sliceLast(ALL_MONTHLY,3); break;
    case '6M': slice=sliceLast(ALL_MONTHLY,6); break;
    case '1A': slice=sliceLast(ALL_MONTHLY,12); break;
    case '5A': slice=sliceLast(ALL_MONTHLY,60); break;
    case 'TUDO': default: slice=[...ALL_MONTHLY];
  }
  if(!slice.length){ drawChart([]); updateStats([]); return; }

  // sincroniza selects com fatia escolhida
  const startSel=document.getElementById('startSel');
  const endSel=document.getElementById('endSel');
  startSel.value=slice[0].Key;
  endSel.value=slice.at(-1).Key;

  drawChart(slice);
  updateStats(slice);
}

function applyManualRange(){
  const startSel=document.getElementById('startSel');
  const endSel=document.getElementById('endSel');
  let s=startSel.value, e=endSel.value;
  if(!s||!e) return;

  // garante ordem
  if(s>e){ const tmp=s; s=e; e=tmp; }

  const slice=filterRange(ALL_MONTHLY,s,e);
  // marca "Tudo" se for abrangente, senÃ£o desmarca e deixa sem destaque
  document.querySelectorAll('.btn[data-window]').forEach(b=>b.classList.remove('active'));
  if(slice.length===ALL_MONTHLY.length) document.querySelector('.btn[data-window="TUDO"]').classList.add('active');

  drawChart(slice);
  updateStats(slice);
}

/* -------------------- Main -------------------- */
(async()=>{
  try{
    const res=await fetch('data/relatorio_faturamento.csv?cb='+Date.now());
    const text=await res.text();
    const delim=text.includes(';')?';':',';
    document.getElementById('debug').textContent=`Delimitador: "${delim}"`;

    const parsed=Papa.parse(text,{header:true,skipEmptyLines:true,delimiter:delim});
    const monthly=normalizeRows(parsed.data);
    ALL_MONTHLY=monthly;

    document.getElementById('debug').textContent+=`\nMeses agregados: ${monthly.length}`;
    if(monthly.length){
      document.getElementById('debug').textContent+=`\nPrimeiro: ${monthly[0].Key}  | Ãšltimo: ${monthly.at(-1).Key}`;
    }

    populatePeriodSelects(monthly);
    drawChart(monthly);
    updateStats(monthly);

    // listeners
    document.querySelectorAll('.btn[data-window]').forEach(b=>{
      b.addEventListener('click',()=>applyWindow(b.dataset.window));
    });
    document.getElementById('applyRange').addEventListener('click',applyManualRange);

  }catch(err){
    console.error(err);
    document.getElementById('debug').textContent+=`\nERRO: ${err}`;
  }finally{
    document.getElementById('loading').classList.add('hidden');
  }
})();
</script>
</body>
</html>
