<!-- v1.0 | Based on √çndices Moveleiro Dashboard v4.9.2 | ¬© Cesar Beninatto -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openfield Moveleiro Performance</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<style>
  :root{
    --bg:#dfe1e1; --card:#fff; --text:#000; --accent:#f5b95f; --accent-b:#e5be74;
    --red:#e53935; --blue:#1e88e5; --purple:#8e24aa; --green:#43a047; --orange:#fb8c00; --brown:#6d4c41; --slate:#546e7a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1400px;margin:0 auto;padding:18px 16px 56px}
  .topbar{
    background:#000;color:#fff;border-bottom:4px solid var(--accent);
    padding:12px 16px;border-radius:10px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  }
  .tleft{font-weight:700;font-size:1.1rem}
  .tright{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .rbtn{
    background:var(--accent);color:#000;border:1px solid var(--accent-b);
    padding:6px 12px;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px
  }
  .rbtn:hover,.rbtn.active{background:#000;color:#fff;border-color:#000}
  .export{background:#fff;color:#000;border:1px solid #333}
  .section{margin:18px 0}
  .titlebar{
    background:#000;color:#fff;padding:12px 16px;border-radius:10px 10px 0 0;font-weight:700;
    display:flex;align-items:center;justify-content:space-between;user-select:none;border-left:6px solid var(--accent);
  }
  .titlebar.collapsible{cursor:pointer}
  .caret{font-size:0.9rem;opacity:.9}
  .card-wrap{overflow:hidden;transition:max-height .2s ease-in-out}
  .card{background:var(--card);border-radius:0 0 10px 10px;box-shadow:0 3px 10px rgba(0,0,0,.08);padding:14px}
  .rangebar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .rangebar input[type="month"]{padding:6px 8px;border-radius:8px;border:1px solid #ccc}
  .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0 2px}
  .metric{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:8px 10px}
  .metric .k{font-size:.85rem;color:#444}
  .metric .v{font-weight:700;font-size:1.05rem}
  .chart{width:100%;height:520px}
  @media (max-width:720px){
    .chart{height:480px}
    .metrics{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="tleft">OPENFIELD MOVELEIRO PERFORMANCE ‚Äî v1.0</div>
      <div class="tright">
        <span id="updated" style="color:#fff;opacity:.9">Atualizado: ‚Äî</span>
        <button class="rbtn export" title="placeholder">Exportar PDF</button>
      </div>
    </div>

    <!-- Vis√£o Geral -->
    <div class="section">
      <div class="titlebar">üìä Vis√£o Geral (Valor e Quantidade)</div>
      <div class="card-wrap" style="max-height:2000px">
        <div class="card">
          <div class="rangebar" id="range-total">
            <button class="rbtn" data-target="chart-total" data-range="3M">3M</button>
            <button class="rbtn" data-target="chart-total" data-range="6M">6M</button>
            <button class="rbtn" data-target="chart-total" data-range="1A">1A</button>
            <button class="rbtn" data-target="chart-total" data-range="5A">5A</button>
            <button class="rbtn" data-target="chart-total" data-range="TUDO">Tudo</button>
            <span style="margin-left:8px;">De</span>
            <input type="month" id="from-total"/>
            <span>at√©</span>
            <input type="month" id="to-total"/>
            <button class="rbtn" onclick="applyCustom('chart-total','from-total','to-total')">Aplicar</button>
            <button class="rbtn" onclick="resetRange('chart-total')">Reset</button>
          </div>

          <div class="metrics" id="metrics-total">
            <div class="metric"><div class="k">Varia√ß√£o total</div><div class="v" id="var-total">‚Äî</div></div>
            <div class="metric"><div class="k">M√©dia mensal</div><div class="v" id="med-total">‚Äî</div></div>
            <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-total">‚Äî</div></div>
          </div>

          <div class="chart" id="chart-total"></div>
        </div>
      </div>
    </div>

    <!-- (Placeholders for next phases) -->
    <div class="section">
      <div class="titlebar collapsible" data-target="card-cat"><span>üí∞ Faturamento por Categoria (Linhas)</span><span class="caret">‚ñº</span></div>
      <div id="card-cat" class="card-wrap" style="max-height:0">
        <div class="card">
          <div class="rangebar" id="range-cat">
            <button class="rbtn" data-target="chart-cat" data-range="3M">3M</button>
            <button class="rbtn" data-target="chart-cat" data-range="6M">6M</button>
            <button class="rbtn" data-target="chart-cat" data-range="1A">1A</button>
            <button class="rbtn" data-target="chart-cat" data-range="5A">5A</button>
            <button class="rbtn" data-target="chart-cat" data-range="TUDO">Tudo</button>
            <span style="margin-left:8px;">De</span>
            <input type="month" id="from-cat"/>
            <span>at√©</span>
            <input type="month" id="to-cat"/>
            <button class="rbtn" onclick="applyCustom('chart-cat','from-cat','to-cat')">Aplicar</button>
            <button class="rbtn" onclick="resetRange('chart-cat')">Reset</button>
          </div>
          <div class="metrics">
            <div class="metric"><div class="k">Varia√ß√£o total</div><div class="v">‚Äî</div></div>
            <div class="metric"><div class="k">M√©dia mensal</div><div class="v">‚Äî</div></div>
            <div class="metric"><div class="k">Volatilidade</div><div class="v">‚Äî</div></div>
          </div>
          <div class="chart" id="chart-cat"></div>
        </div>
      </div>
    </div>

  </div>

<script>
/* ---------------------- Helpers ---------------------- */
const MESES_PT = ["","Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
function brToFloat(v){
  if (v==null) return 0;
  const s = String(v).trim();
  if (!s) return 0;
  // handle Brazilian formatting: 3.693.838,12 -> 3693838.12
  return parseFloat(s.replace(/\./g,"").replace(",",".")) || 0;
}
function fmtBRL(n){
  return "R$ " + (Math.round(n)).toLocaleString("pt-BR");
}
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function addMonths(d, m){ return new Date(d.getFullYear(), d.getMonth()+m, 1); }
function ymToDate(s){ if(!s) return null; const p=s.split("-"); if(p.length!==2) return null; return new Date(parseInt(p[0]), parseInt(p[1])-1, 1); }

/* ---------------- Collapsibles ---------------- */
document.querySelectorAll('.titlebar.collapsible').forEach(el=>{
  el.addEventListener('click', ()=>{
    const id = el.getAttribute('data-target');
    const wrap = document.getElementById(id);
    if(!wrap) return;
    const open = (!wrap.style.maxHeight || wrap.style.maxHeight==='0px');
    wrap.style.maxHeight = open ? '9999px' : '0';
    const caret = el.querySelector('.caret');
    if (caret) caret.textContent = open ? '‚ñº' : '‚ñ∂';
  });
});

/* --------------- Range Controls --------------- */
let DATA_MIN = null, DATA_MAX = null;
function applyRangeTo(divId, start, end){
  const gd = document.getElementById(divId);
  if(!gd) return;
  Plotly.relayout(gd, {'xaxis.range':[start, end]});
}
function quick(divId, key){
  let start, end = endOfMonth(DATA_MAX);
  if (key==='3M') start = startOfMonth(addMonths(DATA_MAX, -2));
  else if (key==='6M') start = startOfMonth(addMonths(DATA_MAX, -5));
  else if (key==='1A') start = startOfMonth(addMonths(DATA_MAX, -11));
  else if (key==='5A') start = startOfMonth(addMonths(DATA_MAX, -59));
  else if (key==='TUDO'){ start = startOfMonth(DATA_MIN); end = endOfMonth(DATA_MAX); }
  else start = startOfMonth(addMonths(DATA_MAX, -11));
  applyRangeTo(divId, start, end);
}
function applyCustom(divId, fromId, toId){
  const f = document.getElementById(fromId).value;
  const t = document.getElementById(toId).value;
  const d1 = ymToDate(f), d2 = ymToDate(t);
  if(!d1 || !d2){ alert('Selecione m√™s/ano inicial e final.'); return; }
  applyRangeTo(divId, startOfMonth(d1), endOfMonth(d2));
}
function resetRange(divId){ quick(divId, '1A'); }
function wireRangeBar(barId){
  const bar = document.getElementById(barId);
  if(!bar) return;
  bar.querySelectorAll('.rbtn[data-range]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      bar.querySelectorAll('.rbtn[data-range]').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');
      quick(btn.dataset.target, btn.dataset.range);
    });
  });
}

/* --------------- Metrics (placeholders) --------------- */
function computeMetrics(rows){
  if(!rows.length) return {varTotal:"‚Äî", medMensal:"‚Äî", vol:"‚Äî"};
  const vals = rows.map(r=>r.Valor);
  const first = vals[0], last = vals[vals.length-1];
  const varTotal = (first===0)? 0 : ((last-first)/Math.abs(first))*100;
  const diffs = [];
  for(let i=1;i<vals.length;i++) diffs.push(Math.abs(vals[i]-vals[i-1]));
  const vol = diffs.length ? (100* (diffs.reduce((a,b)=>a+b,0)/diffs.length) / (Math.max(...vals)||1)) : 0;
  const medMensal = (vals.reduce((a,b)=>a+b,0)/vals.length);
  return {
    varTotal: (varTotal).toFixed(1).replace(".",",")+" %",
    medMensal: fmtBRL(medMensal),
    vol: vol.toFixed(1).replace(".",",")+" %"
  };
}

/* --------------- Main Init --------------- */
function initDashboard(parsed){
  // Normalize columns: Data/date, Valor, Quantidade, Categoria
  const rows = [];
  parsed.forEach(o=>{
    const DataStr = o.Data || o.date || "";
    let d = null;
    if (DataStr){
      // try YYYY-MM-DD or DD/MM/YYYY
      if (/^\d{4}-\d{2}-\d{2}$/.test(DataStr)){
        d = new Date(DataStr);
      } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(DataStr)){
        const [dd,mm,yy] = DataStr.split("/");
        d = new Date(parseInt(yy), parseInt(mm)-1, parseInt(dd));
      }
    } else if (o.Ano && o.Mes){
      d = new Date(parseInt(o.Ano), parseInt(o.Mes)-1, 1);
    }
    if (!d || isNaN(d.getTime())) return;
    rows.push({
      Data: new Date(d.getFullYear(), d.getMonth(), 1),
      Ano: d.getFullYear(),
      Mes: d.getMonth()+1,
      Valor: brToFloat(o.Valor),
      Quantidade: brToFloat(o.Quantidade),
      Categoria: (o.Categoria||"").trim()
    });
  });
  rows.sort((a,b)=>a.Data - b.Data);

  // Month-end reduction: keep last entry of each (Ano,Mes)
  const key = r=> `${r.Ano}-${String(r.Mes).padStart(2,"0")}`;
  const lastByMonth = {};
  rows.forEach(r=> lastByMonth[key(r)] = r);
  const monthRows = Object.values(lastByMonth).sort((a,b)=>a.Data - b.Data);

  // Totais mensais
  const monthlyMap = {};
  monthRows.forEach(r=>{
    const k = r.Data.toISOString().slice(0,10);
    if (!monthlyMap[k]) monthlyMap[k] = {Data:r.Data, Valor:0, Quantidade:0};
    monthlyMap[k].Valor += r.Valor;
    monthlyMap[k].Quantidade += r.Quantidade;
  });
  const monthly = Object.values(monthlyMap).sort((a,b)=>a.Data - b.Data);

  // Updated label
  const maxD = monthly.length ? monthly[monthly.length-1].Data : new Date();
  const updated = `${MESES_PT[maxD.getMonth()+1]}/${maxD.getFullYear()}`;
  document.getElementById("updated").textContent = "Atualizado: " + updated;

  // Global min/max for range helpers
  DATA_MIN = monthly[0]?.Data || new Date();
  DATA_MAX = maxD;

  /* ---------- Vis√£o Geral (dual y) ---------- */
  const x = monthly.map(r=>r.Data);
  const hover = monthly.map(r=>{
    const m = MESES_PT[r.Data.getMonth()+1] + " " + r.Data.getFullYear();
    return {m, v: fmtBRL(r.Valor), q: (Math.round(r.Quantidade)).toLocaleString("pt-BR")+" un."};
  });

  const fig = {
    data: [
      {
        x, y: monthly.map(r=>r.Valor), name:"Valor (R$)",
        type:"scatter", mode:"lines+markers",
        line:{width:3, color:"var(--red)"}, marker:{size:7, color:"var(--red)"},
        hovertemplate:"<b>%{customdata.m}</b><br>Valor: %{customdata.v}<br>Quantidade: %{customdata.q}<extra></extra>",
        customdata: hover, yaxis:"y1"
      },
      {
        x, y: monthly.map(r=>r.Quantidade), name:"Quantidade (un.)",
        type:"scatter", mode:"lines+markers",
        line:{width:3, color:"var(--blue)"}, marker:{size:7, color:"var(--blue)"},
        hovertemplate:"<b>%{customdata.m}</b><br>Valor: %{customdata.v}<br>Quantidade: %{customdata.q}<extra></extra>",
        customdata: hover, yaxis:"y2"
      }
    ],
    layout:{
      title:null, hovermode:"x unified",
      plot_bgcolor:"var(--card)", paper_bgcolor:"var(--card)",
      font:{color:"var(--text)", size:13},
      xaxis:{range:[startOfMonth(addMonths(DATA_MAX,-11)), endOfMonth(DATA_MAX)], showgrid:false},
      yaxis:{title:"Valor (R$)", tickformat: ",.0f", showgrid:true, gridcolor:"#e9ecef",
             titlefont:{color:"var(--red)"}, tickfont:{color:"var(--red)"}},
      yaxis2:{title:"Quantidade (un.)", overlaying:"y", side:"right", showgrid:false,
              titlefont:{color:"var(--blue)"}, tickfont:{color:"var(--blue)"}},
      legend:{orientation:"h", yanchor:"bottom", y:1.02, xanchor:"center", x:0.5, bgcolor:"rgba(0,0,0,0)"}
    },
    config:{responsive:true}
  };
  Plotly.newPlot("chart-total", fig.data, fig.layout, fig.config);

  // Wire range bar
  wireRangeBar("range-total");

  // Metrics (simple placeholders; we‚Äôll refine in Phase 2)
  const m = computeMetrics(monthly);
  document.getElementById("var-total").textContent = m.varTotal;
  document.getElementById("med-total").textContent = m.medMensal;
  document.getElementById("vol-total").textContent = m.vol;

  /* ---------- TODO in Phase 2 ----------
     - Faturamento por Categoria (multi-line with dual y)
     - Desempenho por Categoria (collapsibles per category)
     - Quarterly summary grid + ‚Äú√öltimo m√™s‚Äù block
     - Abbreviated month ticks (JAN 24, FEV 24‚Ä¶)
  -------------------------------------- */
}

/* --------- Load CSV via PapaParse ---------- */
Papa.parse("data/relatorio_faturamento.csv", {
  download: true,
  header: true,
  skipEmptyLines: true,
  complete: function(res){ initDashboard(res.data); },
  error: function(err){ alert("Erro ao carregar CSV: " + err); }
});
</script>
</body>
</html>
