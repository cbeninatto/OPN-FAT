<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Performance Moveleiro — Fase 3</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<style>
  :root{
    --bg: #dfe1e1;
    --gold: #f5b95f;
    --card: #ffffff;
    --text: #1d1f21;
    --muted:#666;
    --grid:#0000001a;
    /* categorias */
    --red:#e53935;
    --orange:#fb8c00;
    --purple:#8e24aa;
    --green:#43a047;
    --teal:#00897b;
    --blue:#1e88e5;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:0;
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg); color:var(--text);
  }
  header{
    background:#000; color:#fff; padding:14px 16px;
    display:flex; align-items:center; justify-content:space-between;
    flex-wrap:wrap; gap:10px;
  }
  header .title{ font-weight:700; letter-spacing:.2px }
  header .meta{ font-size:12px; opacity:.9 }
  main{ padding:16px; max-width:1200px; margin:0 auto; }
  .card{
    background:var(--card); border-radius:14px; padding:14px 16px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
  }
  .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .btn{
    border:1px solid #000; background:#000; color:#fff;
    padding:6px 10px; border-radius:999px; font-size:12px; cursor:pointer;
  }
  .btn.secondary{ background:#fff; color:#000; }
  .btn.active{ outline:2px solid var(--gold); }
  .spacer{ flex:1 1 auto }
  .inputs{ display:flex; gap:8px; align-items:center; }
  .inputs input[type="month"]{ padding:6px 8px; border-radius:8px; border:1px solid #ccc; background:#fff; }
  .section-title{
    display:flex; align-items:center; gap:8px; margin:10px 0 6px 0;
    font-weight:700;
  }
  .pill{ background:#000; color:#fff; border-radius:999px; font-size:11px; padding:2px 8px; }
  /* Quarterly cards */
  #quarterly-summary{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:12px; margin:12px 0 14px 0;
  }
  .quarter-card{
    background:#fff; border-radius:12px; padding:12px 14px; text-align:center;
    box-shadow:0 2px 6px rgba(0,0,0,0.08);
  }
  .quarter-card h4{ margin:0; font-size:14px; font-weight:700 }
  .quarter-card p{ margin:4px 0; font-size:13px; color:#333 }
  .delta.pos{ color:#1b5e20; font-weight:600 }
  .delta.neg{ color:#b71c1c; font-weight:600 }
  .delta.neu{ color:#777; font-weight:600 }
  /* Visão Geral layout */
  #visao-geral{ margin-top:10px; }
  .plot{ width:100%; height:460px; }
  /* Footer */
  footer{ text-align:center; color:#555; font-size:12px; padding:18px 0 28px 0; }
  /* Helpers */
  .muted{ color:var(--muted) }
  .gold{ color:var(--gold) }
</style>
</head>
<body>
<header>
  <div class="title">Performance Moveleiro — <span class="pill">Fase 3</span></div>
  <div class="meta">Atualizado: <span id="atualizado"></span></div>
</header>

<main>
  <section class="card" id="section-visao-geral">
    <div class="section-title">
      <span>Visão Geral</span>
      <span class="pill">Valor (R$) & Quantidade (PÇS)</span>
    </div>
    <div class="toolbar">
      <button class="btn range" data-range="3M">3M</button>
      <button class="btn range" data-range="6M">6M</button>
      <button class="btn range" data-range="1A">1A</button>
      <button class="btn range" data-range="5A">5A</button>
      <button class="btn range active" data-range="TUDO">Tudo</button>
      <div class="spacer"></div>
      <div class="inputs">
        <label class="muted" for="from">De</label>
        <input type="month" id="from">
        <label class="muted" for="to">Até</label>
        <input type="month" id="to">
        <button class="btn secondary" id="applyRange">Aplicar</button>
      </div>
    </div>

    <!-- Quarterly summary cards injected here -->
    <div id="quarterly-summary"></div>

    <div id="plot-visao-geral" class="plot"></div>
  </section>

  <!-- Stubs for other sections (kept minimal, not breaking structure) -->
  <section class="card" style="margin-top:14px">
    <div class="section-title">
      <span>Faturamento por Categoria</span>
      <span class="pill">Grid e cores padrão</span>
    </div>
    <p class="muted" style="margin:0">
      (Seção mantida como placeholder nesta entrega; foco desta fase está na Visão Geral, hovers compactos e cartões trimestrais vinculados ao filtro.)
    </p>
  </section>
</main>

<footer>
  <span>Openfield • Visual padrão v4.9.2 • Acentos <span class="gold">#f5b95f</span></span>
</footer>

<script>
/* ---------------------
   Utils & Formatting
---------------------- */
const BRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits:0 });
const INT = new Intl.NumberFormat('pt-BR', { maximumFractionDigits:0 });

// Month labels (PT) for tick text
const PT_MONTHS = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];
function monthLabel(date){
  const d = new Date(date);
  const m = PT_MONTHS[d.getUTCMonth()];
  const y = String(d.getUTCFullYear()).slice(-2);
  return `${m} ${y}`;
}
function yyyymm(date){
  const d = new Date(date);
  return d.getUTCFullYear()*100 + (d.getUTCMonth()+1);
}
function firstDayUTC(year, month){ // month 1-12
  return new Date(Date.UTC(year, month-1, 1));
}
function endOfMonthUTC(year, month){
  return new Date(Date.UTC(year, month, 0, 23,59,59));
}
function parseNumber(v){
  if (v === null || v === undefined) return null;
  if (typeof v === 'number') return v;
  // replace thousand separators and decimal comma if present
  const s = String(v).trim().replace(/\./g,'').replace(',','.');
  const n = Number(s);
  return isFinite(n) ? n : null;
}

/* ---------------------
   Data Pipeline
---------------------- */
const DATA_URL = './data/relatorio_faturamento.csv';

let rawRows = [];
let monthly = []; // normalized per-month series for Visão Geral
let minMonth, maxMonth;

function loadCSV(){
  return new Promise((resolve, reject) => {
    Papa.parse(DATA_URL, {
      download: true,
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: (results) => resolve(results.data),
      error: (err) => reject(err)
    });
  });
}

function normalize(rows){
  // Expected columns: Codigo, Descricao, Quantidade, Valor, Mes, Ano
  // Aggregate by Ano-Mes (sum Valor and Quantidade); date set to first day of month.
  const map = new Map();
  rows.forEach(r => {
    const ano = parseInt(r.Ano, 10);
    const mes = parseInt(r.Mes, 10);
    const valor = parseNumber(r.Valor) || 0;
    const qtd = parseNumber(r.Quantidade) || 0;
    if (!ano || !mes) return;

    const key = `${ano}-${String(mes).padStart(2,'0')}`;
    if (!map.has(key)){
      map.set(key, { ano, mes, valor:0, qtd:0, date:firstDayUTC(ano, mes) });
    }
    const obj = map.get(key);
    obj.valor += valor;
    obj.qtd += qtd;
  });

  // sort by date
  const list = Array.from(map.values()).sort((a,b) => a.date - b.date);

  // track bounds
  if (list.length){
    minMonth = list[0].date;
    maxMonth = list[list.length-1].date;
  }
  return list;
}

function updateAtualizado(date){
  if (!date) return;
  const m = PT_MONTHS[date.getUTCMonth()];
  const y = date.getUTCFullYear();
  document.getElementById('atualizado').textContent = `${m} ${y}`;
}

/* ---------------------
   Filtering
---------------------- */
let currentRange = 'TUDO';
let customFrom = null, customTo = null;

function setRangeButtons(active){
  document.querySelectorAll('.btn.range').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.range === active);
  });
}

function filterByRange(range, list){
  if (!list.length) return [];
  const last = list[list.length-1].date;
  let from = null;
  if (range === '3M'){
    from = new Date(Date.UTC(last.getUTCFullYear(), last.getUTCMonth()-2, 1));
  } else if (range === '6M'){
    from = new Date(Date.UTC(last.getUTCFullYear(), last.getUTCMonth()-5, 1));
  } else if (range === '1A'){
    from = new Date(Date.UTC(last.getUTCFullYear()-1, last.getUTCMonth(), 1));
  } else if (range === '5A'){
    from = new Date(Date.UTC(last.getUTCFullYear()-5, last.getUTCMonth(), 1));
  } else if (range === 'TUDO'){
    from = list[0].date;
  }
  const to = endOfMonthUTC(last.getUTCFullYear(), last.getUTCMonth()+1);
  return list.filter(d => d.date >= from && d.date <= to);
}

function filterByCustom(list){
  if (!customFrom || !customTo) return list;
  const [yf, mf] = customFrom.split('-').map(Number);
  const [yt, mt] = customTo.split('-').map(Number);
  const fromDate = firstDayUTC(yf, mf);
  const toDate = endOfMonthUTC(yt, mt);
  return list.filter(d => d.date >= fromDate && d.date <= toDate);
}

/* ---------------------
   Quarterly Summary (Visão Geral only)
---------------------- */
function getQuarterKey(d){ // d has .ano, .mes
  const q = Math.ceil(d.mes / 3);
  return `${d.ano}-Q${q}`;
}
function computeQuarterly(filtered){
  // Group by quarter using monthly sums, then average by month inside quarter
  const map = new Map();
  filtered.forEach(d => {
    const key = getQuarterKey(d);
    if (!map.has(key)) map.set(key, { ano:d.ano, key, valor:[], qtd:[] });
    const o = map.get(key);
    o.valor.push(d.valor);
    o.qtd.push(d.qtd);
  });
  const arr = Array.from(map.values()).sort((a,b)=> a.ano - b.ano || a.key.localeCompare(b.key))
    .map(o => ({
      key:o.key,
      avgValor: o.valor.length ? o.valor.reduce((s,v)=>s+v,0)/o.valor.length : 0,
      avgQtd:   o.qtd.length ? o.qtd.reduce((s,v)=>s+v,0)/o.qtd.length : 0
    }));
  // deltas vs previous quarter (based on order in filtered range)
  for (let i=0;i<arr.length;i++){
    if (i===0){ arr[i].delta = null; continue; }
    const prev = arr[i-1];
    arr[i].delta = (prev.avgValor === 0) ? null : ( (arr[i].avgValor - prev.avgValor) / prev.avgValor * 100 );
  }
  return arr;
}
function renderQuarterCards(qArr){
  const host = document.getElementById('quarterly-summary');
  host.innerHTML = '';
  if (!qArr.length){
    host.innerHTML = '<p class="muted" style="margin:0">Sem dados no período selecionado.</p>';
    return;
  }
  qArr.forEach(q => {
    const deltaClass = q.delta == null ? 'neu' : (q.delta >= 0 ? 'pos' : 'neg');
    const deltaText = q.delta == null ? '—' : `${q.delta>=0?'+':''}${q.delta.toFixed(1)}%`;
    const card = document.createElement('div');
    card.className = 'quarter-card';
    card.innerHTML = `
      <h4>${q.key}</h4>
      <p>Média: <strong>${BRL.format(q.avgValor)}</strong> | <strong>${INT.format(q.avgQtd)}</strong> PÇS</p>
      <p class="delta ${deltaClass}">∆ vs. Trim. Ant.: ${deltaText}</p>
    `;
    host.appendChild(card);
  });
}

/* ---------------------
   Visão Geral Plot
---------------------- */
function buildVisaoGeral(filtered){
  const x = filtered.map(d => d.date.toISOString().split('T')[0]);
  const tickvals = x.slice(); // monthly tick each x
  const ticktext = filtered.map(d => monthLabel(d.date));
  const valor = filtered.map(d => d.valor);
  const qtd = filtered.map(d => d.qtd);

  // Trace: Valor (bars)
  const traceValor = {
    x, y: valor,
    type: 'bar',
    name: 'Valor (R$)',
    marker: { color:'#000' },
    hovertemplate: "<b>%{x}</b><br>Valor: %{customdata}<extra></extra>",
    customdata: valor.map(v => BRL.format(v)),
    yaxis: 'y1'
  };
  // Trace: Quantidade (line)
  const traceQtd = {
    x, y: qtd,
    type: 'scatter', mode:'lines+markers',
    name: 'Quantidade (PÇS)',
    line: { color:'#555', width:2 },
    marker: { size:6 },
    hovertemplate: "<b>%{x}</b><br>Qtd: %{customdata} PÇS<extra></extra>",
    customdata: qtd.map(v => INT.format(v)),
    yaxis: 'y2'
  };

  const layout = {
    barmode:'group',
    margin:{ t:10, r:20, b:40, l:50 },
    xaxis:{
      type:'date',
      tickmode:'array',
      tickvals, ticktext,
      ticklabelmode:'period',
      tickfont:{ family:'Inter', size:12, color:'#333' },
      showgrid:true, gridcolor: 'rgba(0,0,0,0.08)'
    },
    yaxis:{
      title:'Valor (R$)',
      titlefont:{size:12},
      gridcolor: 'rgba(0,0,0,0.08)',
      rangemode:'tozero'
    },
    yaxis2:{
      title:'Quantidade (PÇS)',
      titlefont:{size:12},
      overlaying:'y',
      side:'right',
      rangemode:'tozero'
    },
    legend:{ orientation:'h', y:-0.2 },
    plot_bgcolor:'#fff', paper_bgcolor:'#fff'
  };

  Plotly.react('plot-visao-geral', [traceValor, traceQtd], layout, {displayModeBar:false, responsive:true});
}

/* ---------------------
   Orchestration
---------------------- */
function refresh(){
  // Range
  let filtered = (currentRange === 'CUSTOM')
    ? filterByCustom(monthly)
    : filterByRange(currentRange, monthly);

  // Build quarterly summary from filtered months
  const q = computeQuarterly(filtered);
  renderQuarterCards(q);

  // Build plot
  buildVisaoGeral(filtered);
}

async function init(){
  try{
    rawRows = await loadCSV();
    monthly = normalize(rawRows);
    updateAtualizado(monthly.length ? monthly[monthly.length-1].date : null);

    // Set custom month inputs
    const fromInput = document.getElementById('from');
    const toInput = document.getElementById('to');
    if (monthly.length){
      const min = monthly[0].date;
      const max = monthly[monthly.length-1].date;
      fromInput.value = `${min.getUTCFullYear()}-${String(min.getUTCMonth()+1).padStart(2,'0')}`;
      toInput.value = `${max.getUTCFullYear()}-${String(max.getUTCMonth()+1).padStart(2,'0')}`;
    }

    refresh();
  }catch(err){
    console.error('Erro ao carregar CSV:', err);
    document.getElementById('plot-visao-geral').innerHTML =
      '<p class="muted">Erro ao carregar dados.</p>';
  }
}

// Range buttons
document.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('.btn.range');
  if (!btn) return;
  currentRange = btn.dataset.range;
  setRangeButtons(currentRange);
  refresh();
});

document.getElementById('applyRange').addEventListener('click', ()=>{
  const f = document.getElementById('from').value;
  const t = document.getElementById('to').value;
  if (f && t){
    customFrom = f; customTo = t;
    currentRange = 'CUSTOM';
    setRangeButtons(''); // none active
    refresh();
  }
});

// Kickoff
init();
</script>
</body>
</html>
