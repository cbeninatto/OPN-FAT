<!-- v5.3.2 | Categorical X-Axis Standard (no auto dates) | Â© Cesar Beninatto -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Openfield Moveleiro Performance â€” v5.3.2</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-latest.min.js?v=5.3.2"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<style>
  :root{ --bg:#dfe1e1; --card:#fff; --text:#000; --accent:#f5b95f; --accent-b:#e5be74; --shadow:0 3px 10px rgba(0,0,0,.08); --blue:#1e88e5; --orange:#fb8c00; }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:1400px;margin:0 auto;padding:18px 16px 56px}
  .topbar{background:#000;color:#fff;border-bottom:4px solid var(--accent);padding:12px 16px;border-radius:10px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .tleft{font-weight:700;font-size:1.1rem}
  .tright{display:flex;gap:8px;align-items:center}
  .rbtn{background:var(--accent);color:#000;border:1px solid var(--accent-b);padding:6px 12px;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px}
  .rbtn:hover,.rbtn.active{background:#000;color:#fff;border-color:#000}
  .section{margin:18px 0}
  .titlebar{background:#000;color:#fff;padding:12px 16px;border-radius:10px 10px 0 0;font-weight:700;display:flex;align-items:center;justify-content:space-between;border-left:6px solid var(--accent)}
  .titlebar.collapsible{cursor:pointer}
  .caret{font-size:.9rem;opacity:.9}
  .card-wrap{overflow:hidden;transition:max-height .35s ease-in-out}
  .card{background:var(--card);border-radius:0 0 10px 10px;box-shadow:var(--shadow);padding:14px}
  .rangebar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .rangebar input[type=month]{padding:6px 8px;border-radius:8px;border:1px solid #ccc}
  .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0 2px}
  .metric{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:8px 10px}
  .metric .k{font-size:.85rem;color:#444}
  .metric .v{font-weight:700;font-size:1.05rem}
  .chart{width:100%;height:520px}
  @media (max-width:720px){.chart{height:460px}.metrics{grid-template-columns:1fr}}
  #loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .25s ease;opacity:1}
  #loading-overlay.hidden{opacity:0;pointer-events:none}
  .loading-box{background:#fff;border-radius:12px;padding:18px 22px;box-shadow:var(--shadow);border:2px solid var(--accent);display:flex;gap:12px;align-items:center}
  .spinner{width:18px;height:18px;border:3px solid #eee;border-top-color:#000;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="loading-overlay"><div class="loading-box"><div class="spinner"></div><div class="loading-text">Carregando dadosâ€¦</div></div></div>
<div class="wrap">
  <div class="topbar">
    <div class="tleft">OPENFIELD MOVELEIRO PERFORMANCE â€” v5.3.2</div>
    <div class="tright"><span id="updated" style="color:#fff;opacity:.9">Atualizado: â€”</span></div>
  </div>

  <!-- VisÃ£o Geral -->
  <div class="section">
    <div class="titlebar">ðŸ“Š VisÃ£o Geral (Valor e Quantidade)</div>
    <div class="card-wrap" style="max-height:none;overflow:visible">
      <div class="card">
        <div class="rangebar" id="range-total">
          <button class="rbtn" data-target="chart-total" data-range="3M">3M</button>
          <button class="rbtn" data-target="chart-total" data-range="6M">6M</button>
          <button class="rbtn" data-target="chart-total" data-range="1A">1A</button>
          <button class="rbtn" data-target="chart-total" data-range="5A">5A</button>
          <button class="rbtn active" data-target="chart-total" data-range="TUDO">Tudo</button>
          <span style="margin-left:8px;">De</span>
          <input type="month" id="from-total"/>
          <span>atÃ©</span>
          <input type="month" id="to-total"/>
          <button class="rbtn" onclick="applyCustom('chart-total','from-total','to-total','total')">Aplicar</button>
          <button class="rbtn" onclick="resetRange('chart-total','total')">Reset</button>
        </div>
        <div class="metrics" id="metrics-total">
          <div class="metric"><div class="k">VariaÃ§Ã£o total</div><div class="v" id="var-total">â€”</div></div>
          <div class="metric"><div class="k">MÃ©dia mensal</div><div class="v" id="med-total">â€”</div></div>
          <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-total">â€”</div></div>
        </div>
        <div class="chart" id="chart-total"></div>
      </div>
    </div>
  </div>

  <!-- Faturamento por Linha (Valor) -->
  <div class="section">
    <div class="titlebar collapsible" data-target="card-fatlin"><span>ðŸ’° Faturamento por Linha (Valor)</span><span class="caret">â–¶</span></div>
    <div id="card-fatlin" class="card-wrap" style="max-height:0"><div class="card">
      <div class="rangebar" id="range-fatlin">
        <button class="rbtn" data-target="chart-fatlin" data-range="3M">3M</button>
        <button class="rbtn" data-target="chart-fatlin" data-range="6M">6M</button>
        <button class="rbtn" data-target="chart-fatlin" data-range="1A">1A</button>
        <button class="rbtn" data-target="chart-fatlin" data-range="5A">5A</button>
        <button class="rbtn active" data-target="chart-fatlin" data-range="TUDO">Tudo</button>
        <span style="margin-left:8px;">De</span>
        <input type="month" id="from-fatlin"/>
        <span>atÃ©</span>
        <input type="month" id="to-fatlin"/>
        <button class="rbtn" onclick="applyCustom('chart-fatlin','from-fatlin','to-fatlin','fatlin')">Aplicar</button>
        <button class="rbtn" onclick="resetRange('chart-fatlin','fatlin')">Reset</button>
      </div>
      <div class="metrics" id="metrics-fatlin">
        <div class="metric"><div class="k">VariaÃ§Ã£o total</div><div class="v" id="var-fatlin">â€”</div></div>
        <div class="metric"><div class="k">MÃ©dia mensal</div><div class="v" id="med-fatlin">â€”</div></div>
        <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-fatlin">â€”</div></div>
      </div>
      <div class="chart" id="chart-fatlin"></div>
    </div></div>
  </div>

  <!-- Volume por Linha (Quantidade) -->
  <div class="section">
    <div class="titlebar collapsible" data-target="card-vollin"><span>ðŸ“¦ Volume por Linha (Quantidade)</span><span class="caret">â–¶</span></div>
    <div id="card-vollin" class="card-wrap" style="max-height:0"><div class="card">
      <div class="rangebar" id="range-vollin">
        <button class="rbtn" data-target="chart-vollin" data-range="3M">3M</button>
        <button class="rbtn" data-target="chart-vollin" data-range="6M">6M</button>
        <button class="rbtn" data-target="chart-vollin" data-range="1A">1A</button>
        <button class="rbtn" data-target="chart-vollin" data-range="5A">5A</button>
        <button class="rbtn active" data-target="chart-vollin" data-range="TUDO">Tudo</button>
        <span style="margin-left:8px;">De</span>
        <input type="month" id="from-vollin"/>
        <span>atÃ©</span>
        <input type="month" id="to-vollin"/>
        <button class="rbtn" onclick="applyCustom('chart-vollin','from-vollin','to-vollin','vollin')">Aplicar</button>
        <button class="rbtn" onclick="resetRange('chart-vollin','vollin')">Reset</button>
      </div>
      <div class="metrics" id="metrics-vollin">
        <div class="metric"><div class="k">VariaÃ§Ã£o total</div><div class="v" id="var-vollin">â€”</div></div>
        <div class="metric"><div class="k">MÃ©dia mensal</div><div class="v" id="med-vollin">â€”</div></div>
        <div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-vollin">â€”</div></div>
      </div>
      <div class="chart" id="chart-vollin"></div>
    </div></div>
  </div>

  <!-- ParticipaÃ§Ã£o por Linha (%) -->
  <div class="section">
    <div class="titlebar collapsible" data-target="card-share"><span>ðŸ“Š ParticipaÃ§Ã£o por Linha (%)</span><span class="caret">â–¶</span></div>
    <div id="card-share" class="card-wrap" style="max-height:0"><div class="card">
      <div class="rangebar" id="range-share">
        <button class="rbtn" data-target="chart-share" data-range="3M">3M</button>
        <button class="rbtn" data-target="chart-share" data-range="6M">6M</button>
        <button class="rbtn" data-target="chart-share" data-range="1A">1A</button>
        <button class="rbtn" data-target="chart-share" data-range="5A">5A</button>
        <button class="rbtn active" data-target="chart-share" data-range="TUDO">Tudo</button>
        <span style="margin-left:8px;">Modo:</span>
        <button class="rbtn" onclick="setShareMode('valor')">Valor</button>
        <button class="rbtn" onclick="setShareMode('quantidade')">Quantidade</button>
      </div>
      <div class="chart" id="chart-share"></div>
    </div></div>
  </div>

  <!-- Desempenho por Linha (cards) -->
  <div class="section">
    <div class="titlebar collapsible" data-target="card-cats"><span>ðŸ“ˆ Desempenho por Linha</span><span class="caret">â–¶</span></div>
    <div id="card-cats" class="card-wrap" style="max-height:0">
      <div class="card" id="cats-container"></div>
    </div>
  </div>
</div>

<script>
// =================== CATEGORICAL AXIS STANDARD =====================
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
// Arizona Sunset palette (for stacked share)
const COLORS={"CorrediÃ§a Oculta":"#d64b4b","CorrediÃ§a TelescÃ³pica":"#f57c00","DobradiÃ§as":"#fdd835","Articuladores":"#81c784","RodÃ­zio":"#4db6ac","Pulsadores":"#9575cd","AcessÃ³rios":"#bcaaa4"};
const ABBR={"CorrediÃ§a Oculta":"ESCON","CorrediÃ§a TelescÃ³pica":"TELES","DobradiÃ§as":"DOBRA","Articuladores":"ARTIC","RodÃ­zio":"RODIZ","Pulsadores":"PULSA","AcessÃ³rios":"ACESS"};
const isMobile=()=>innerWidth<720;

// ---- Collapsible helpers (auto height) ----
function expandWrap(wrap){wrap.style.overflow='hidden';wrap.style.maxHeight='0px';const h=wrap.scrollHeight;wrap.style.maxHeight=h+'px';wrap.addEventListener('transitionend',function te(){wrap.removeEventListener('transitionend',te);wrap.style.maxHeight='none';wrap.style.overflow='visible';wrap.querySelectorAll('.chart').forEach(c=>Plotly.Plots.resize(c));},{once:true});}
function collapseWrap(wrap){if(getComputedStyle(wrap).maxHeight==='none'){wrap.style.maxHeight=wrap.scrollHeight+'px';wrap.offsetHeight;}wrap.style.overflow='hidden';wrap.style.maxHeight='0px';}
addEventListener('click',ev=>{const tb=ev.target.closest('.titlebar.collapsible');if(!tb)return;const id=tb.getAttribute('data-target');const wrap=document.getElementById(id);const open=(!wrap.style.maxHeight||wrap.style.maxHeight==='0px');open?expandWrap(wrap):collapseWrap(wrap);const caret=tb.querySelector('.caret');if(caret)caret.textContent=open?'â–¼':'â–¶';});

// ---- Parsing + Normalization (NO DATES) ----
function detectDelimiter(text){const first=text.split(/\r?\n/)[0]||'';const c1=(first.match(/,/g)||[]).length;const c2=(first.match(/;/g)||[]).length;return c2>c1?';':',';}
function normalizeRows(rows){const out=[];rows.forEach(o=>{const Ano=Number(o.Ano||o.ano||o.ANO||0);const Mes=Number(o.Mes||o.mes||o.MES||0);if(!Ano||!Mes)return;const Valor=Number(o.Valor)||0;const Quantidade=Number(o.Quantidade)||0;const Key=`${Ano}-${String(Mes).padStart(2,'0')}`;out.push({Ano,Mes,Valor,Quantidade,Key,Categoria:mapCategoria(o.Descricao||o.Categoria||'')});});out.sort((a,b)=>a.Key.localeCompare(b.Key));return out;}
function mapCategoria(d){d=(d||'').toUpperCase();if(d.includes('ESCOND')||d.includes('SLIM MV119')||d.includes('DREAM BOX')||d.includes('OPENBOX')||(d.includes('GAVETA')&&(d.includes('BOX')||d.includes('OPENBOX'))))return'CorrediÃ§a Oculta';if(d.includes('TRILHO LIGHT')||d.includes('TRILHO LIFE')||d.includes('TRILHO MOVE')||d.includes('TRILHO LIGTH')||(d.includes('TRILHO')&&(d.includes('NORMAL')||d.includes('TELE')||d.includes('TEL'))))return'CorrediÃ§a TelescÃ³pica';if(d.includes('DOBRAD'))return'DobradiÃ§as';if(d.includes('PIST')||d.includes('ARTICUL'))return'Articuladores';if(d.includes('RODIZ'))return'RodÃ­zio';if(d.includes('PULSADOR')||d.includes('TIP-ON')||d.includes('TIP ON'))return'Pulsadores';return'AcessÃ³rios';}

function aggMonthly(rows){const m=new Map();rows.forEach(r=>{const k=r.Key;if(!m.has(k))m.set(k,{Ano:r.Ano,Mes:r.Mes,Key:k,Valor:0,Quantidade:0});const o=m.get(k);o.Valor+=r.Valor;o.Quantidade+=r.Quantidade;});return Array.from(m.values()).sort((a,b)=>a.Key.localeCompare(b.Key));}
function aggMonthlyByCat(rows,keys){const cats=[...new Set(rows.map(r=>r.Categoria))];const table={};cats.forEach(c=>table[c]=keys.map(k=>({Key:k,Valor:0,Quantidade:0})));rows.forEach(r=>{const arr=table[r.Categoria];const idx=keys.indexOf(r.Key);if(idx>-1){arr[idx].Valor+=r.Valor;arr[idx].Quantidade+=r.Quantidade;}});return {cats,table};}

// ---- Category axis layout ----
function baseLayoutCategory(x,ticktext,yTitleL,yTitleR){const tf=isMobile()?10:12;const lay={hovermode:'x unified',legend:{orientation:'h',y:-0.25,font:{size:isMobile()?11:12}},xaxis:{type:'category',categoryorder:'array',categoryarray:x,tickmode:'array',tickvals:x,ticktext:ticktext,showgrid:false,automargin:true},yaxis:{gridcolor:'#e9ecef',zeroline:false,title:yTitleL,tickfont:{size:tf},automargin:true},paper_bgcolor:'#fff',plot_bgcolor:'#fff',margin:{t:20,r:30,b:80,l:60}};if(yTitleR){lay.yaxis2={title:yTitleR,overlaying:'y',side:'right',tickfont:{size:tf},automargin:true};}return lay;}
function lineCfg(color){return{type:'scatter',mode:'lines+markers',line:{shape:'spline',smoothing:.6,width:isMobile()?2:3,color},marker:{size:isMobile()?5:7,line:{width:1,color:'#fff'}},cliponaxis:false}};function barCfg(color){return{type:'bar',marker:{color},opacity:.95}};
function monthLabelsFromMonthly(m){return m.map(x=>`${PT_ABBR[x.Mes-1]} ${String(x.Ano).slice(-2)}`)}

// ---- Range management on categorical axis ----
let DATA_KEYS=[];let DATA_MIN_KEY=null,DATA_MAX_KEY=null;
function keyIndex(k){return DATA_KEYS.indexOf(k);} 
function rangeBySpan(span){const last=DATA_KEYS.length-1;let n={"3M":3,"6M":6,"1A":12,"5A":60,"TUDO":DATA_KEYS.length}[span]||12;let start=Math.max(0,last-n+1);return [DATA_KEYS[start],DATA_KEYS[last]];}
function relayoutRange(divId,startKey,endKey,sec){Plotly.relayout(divId,{"xaxis.range":[startKey,endKey]}).then(()=>updateMetricsForRange(sec,startKey,endKey));}
function quick(divId,span){const [s,e]=rangeBySpan(span);relayoutRange(divId,s,e,divId.replace('chart-',''));}
function applyCustom(divId,fromId,toId,sec){const f=document.getElementById(fromId).value;const t=document.getElementById(toId).value;if(!f||!t)return alert('Selecione mÃªs/ano inicial e final.');const s=`${f.slice(0,4)}-${f.slice(5,7)}`;const e=`${t.slice(0,4)}-${t.slice(5,7)}`;relayoutRange(divId,s,e,sec);} 
function resetRange(divId,sec){quick(divId,'1A');}
function wireRangeBar(id){const bar=document.getElementById(id);if(!bar)return;bar.querySelectorAll('.rbtn[data-range]').forEach(btn=>{btn.addEventListener('click',()=>{bar.querySelectorAll('.rbtn[data-range]').forEach(x=>x.classList.remove('active'));btn.classList.add('active');quick(btn.dataset.target,btn.dataset.range);});});}

// ---- Metrics ----
function fmtBRL(n){return 'R$ '+n.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});}
function computeMetrics(rows,key){const vals=rows.map(r=>r[key]||0);if(!vals.length)return{var:'â€”',med:'â€”',vol:'â€”'};if(vals.length===1)return{var:'0,0 %',med:key==='Valor'?fmtBRL(vals[0]):Math.round(vals[0]).toLocaleString('pt-BR'),vol:'0,0 %'};const first=vals[0],last=vals[vals.length-1];const vr=(first===0)?0:((last-first)/Math.abs(first))*100;const diffs=[];for(let i=1;i<vals.length;i++)diffs.push((vals[i-1]===0)?0:((vals[i]-vals[i-1])/Math.abs(vals[i-1])*100));const vol=diffs.length?(diffs.reduce((a,b)=>a+Math.abs(b),0)/diffs.length):0;const med=vals.reduce((a,b)=>a+b,0)/vals.length;return{var:vr.toFixed(1).replace('.',',')+' %',med:key==='Valor'?fmtBRL(med):Math.round(med).toLocaleString('pt-BR'),vol:vol.toFixed(1).replace('.',',')+' %'};}
function updateMetricsForRange(sectionKey,startKey,endKey){const sI=keyIndex(startKey),eI=keyIndex(endKey);if(sI<0||eI<0)return;const slice=(arr)=>arr.filter((_,i)=>i>=sI&&i<=eI);if(sectionKey==='total'){updateMetrics('total',slice(MONTHLY),'Valor');}else if(sectionKey==='fatlin'){const rows=DATA_KEYS.map((k,i)=>{let sum=0;CAT_ORDER.forEach(cat=>sum+=(BY_CAT[cat]||[])[i]?.Valor||0);return {Key:k,Valor:sum};});updateMetrics('fatlin',slice(rows),'Valor');}else if(sectionKey==='vollin'){const rows=DATA_KEYS.map((k,i)=>{let sum=0;CAT_ORDER.forEach(cat=>sum+=(BY_CAT[cat]||[])[i]?.Quantidade||0);return {Key:k,Quantidade:sum};});updateMetrics('vollin',slice(rows),'Quantidade');}}
function updateMetrics(prefix,rows,key){const m=computeMetrics(rows,key);document.getElementById(`var-${prefix}`).textContent=m.var;document.getElementById(`med-${prefix}`).textContent=m.med;document.getElementById(`vol-${prefix}`).textContent=m.vol;}

// ---- Data holders ----
let RAW=[],MONTHLY=[],BY_CAT={},CAT_ORDER=[];let SHARE_MODE='valor';

// ---- Drawers ----
function drawTotal(){if(!MONTHLY.length)return;const x=MONTHLY.map(r=>r.Key);const ticktext=monthLabelsFromMonthly(MONTHLY);const barsVal={x,y:MONTHLY.map(r=>r.Valor),...barCfg(getComputedStyle(document.documentElement).getPropertyValue('--blue')||'#1e88e5'),name:'Valor (R$)',yaxis:'y',hovertemplate:'<b>Valor:</b> %{customdata.v}<extra></extra>',customdata:MONTHLY.map(r=>({v:fmtBRL(r.Valor)}))};const lineQtd={x,y:MONTHLY.map(r=>r.Quantidade),...lineCfg(getComputedStyle(document.documentElement).getPropertyValue('--orange')||'#fb8c00'),name:'Quantidade (un.)',yaxis:'y2',hovertemplate:'<b>Quantidade:</b> %{customdata.q}<extra></extra>',customdata:MONTHLY.map(r=>({q:Math.round(r.Quantidade).toLocaleString('pt-BR')}))};const layout=baseLayoutCategory(x,ticktext,'Valor (R$)','Quantidade (un.)');Plotly.newPlot('chart-total',[barsVal,lineQtd],layout,{responsive:true});updateMetrics('total',MONTHLY,'Valor');}
function drawRevenue(){const x=DATA_KEYS;const ticktext=monthLabelsFromMonthly(MONTHLY);const traces=CAT_ORDER.map(cat=>{const s=(BY_CAT[cat]||[]);return {x,y:s.map(r=>r.Valor),...lineCfg(COLORS[cat]||'#666'),name:`${ABBR[cat]||cat} (R$)`,hovertemplate:`<b>${ABBR[cat]||cat}:</b> %{customdata.v}<extra></extra>`,customdata:s.map(r=>({v:fmtBRL(r.Valor)}))};});const layout=baseLayoutCategory(x,ticktext,'Valor (R$)',null);Plotly.newPlot('chart-fatlin',traces,layout,{responsive:true});const rows=x.map((k,i)=>{let sum=0;CAT_ORDER.forEach(cat=>sum+=(BY_CAT[cat]||[])[i]?.Valor||0);return {Key:k,Valor:sum};});updateMetrics('fatlin',rows,'Valor');}
function drawVolume(){const x=DATA_KEYS;const ticktext=monthLabelsFromMonthly(MONTHLY);const traces=CAT_ORDER.map(cat=>{const s=(BY_CAT[cat]||[]);return {x,y:s.map(r=>r.Quantidade),...lineCfg(COLORS[cat]||'#666'),name:`${ABBR[cat]||cat} (un.)`,hovertemplate:`<b>${ABBR[cat]||cat}:</b> %{customdata.q}<extra></extra>`,customdata:s.map(r=>({q:Math.round(r.Quantidade).toLocaleString('pt-BR')}))};});const layout=baseLayoutCategory(x,ticktext,'Quantidade (un.)',null);Plotly.newPlot('chart-vollin',traces,layout,{responsive:true});const rows=x.map((k,i)=>{let sum=0;CAT_ORDER.forEach(cat=>sum+=(BY_CAT[cat]||[])[i]?.Quantidade||0);return {Key:k,Quantidade:sum};});updateMetrics('vollin',rows,'Quantidade');}
function setShareMode(m){SHARE_MODE=(m==='quantidade')?'quantidade':'valor';drawShare(true);} 
function drawShare(skip){const x=DATA_KEYS;const ticktext=monthLabelsFromMonthly(MONTHLY);const denom=x.map((k,i)=>{let s=0;CAT_ORDER.forEach(cat=>{const v=(BY_CAT[cat]||[])[i]||{Valor:0,Quantidade:0};s+=(SHARE_MODE==='valor')?v.Valor:v.Quantidade;});return s>0?s:1;});const traces=CAT_ORDER.map(cat=>{const s=(BY_CAT[cat]||[]);const vals=s.map((r,i)=>{const v=(SHARE_MODE==='valor')?r.Valor:r.Quantidade;return (v/denom[i])*100;});return {x,y:vals,type:'bar',marker:{color:COLORS[cat]||'#666'},name:ABBR[cat]||cat,hovertemplate:`<b>${ABBR[cat]||cat}:</b> %{y:.1f}%<extra></extra>`};});const layout=baseLayoutCategory(x,ticktext,'ParticipaÃ§Ã£o (%)',null);layout.barmode='stack';layout.yaxis.range=[0,100];layout.hoverlabel={bgcolor:'#000',font:{color:'#fff',size:12},bordercolor:'#f5b95f'};Plotly.newPlot('chart-share',traces,layout,{responsive:true});if(!skip)quick('chart-share','TUDO');}

function buildCategoryCards(){const container=document.getElementById('cats-container');container.innerHTML=CAT_ORDER.map(cat=>{const slug=cat.replace(/\s+/g,'-').toLowerCase();return `<div class="section"><div class="titlebar collapsible" data-target="card-${slug}"><span>${cat}</span><span class="caret">â–¶</span></div><div id="card-${slug}" class="card-wrap" style="max-height:0"><div class="card"><div class="rangebar" id="range-${slug}"><button class="rbtn" data-target="chart-${slug}" data-range="3M">3M</button><button class="rbtn" data-target="chart-${slug}" data-range="6M">6M</button><button class="rbtn" data-target="chart-${slug}" data-range="1A">1A</button><button class="rbtn" data-target="chart-${slug}" data-range="5A">5A</button><button class="rbtn active" data-target="chart-${slug}" data-range="TUDO">Tudo</button><span style="margin-left:8px;">De</span><input type="month" id="from-${slug}"/><span>atÃ©</span><input type="month" id="to-${slug}"/><button class="rbtn" onclick="applyCustom('chart-${slug}','from-${slug}','to-${slug}','${slug}')">Aplicar</button><button class="rbtn" onclick="resetRange('chart-${slug}','${slug}')">Reset</button></div><div class="metrics"><div class="metric"><div class="k">VariaÃ§Ã£o total</div><div class="v" id="var-${slug}">â€”</div></div><div class="metric"><div class="k">MÃ©dia mensal</div><div class="v" id="med-${slug}">â€”</div></div><div class="metric"><div class="k">Volatilidade</div><div class="v" id="vol-${slug}">â€”</div></div></div><div class="chart" id="chart-${slug}"></div></div></div></div>`}).join('');
  container.querySelectorAll('.titlebar.collapsible').forEach(tb=>{tb.addEventListener('click',()=>{const id=tb.getAttribute('data-target');const wrap=document.getElementById(id);const opening=(!wrap.style.maxHeight||wrap.style.maxHeight==='0px');if(opening){expandWrap(wrap);const chartId=id.replace('card-','chart-');drawCategory(chartId);tb.scrollIntoView({behavior:'smooth',block:'start'});}else{collapseWrap(wrap);}const caret=tb.querySelector('.caret');if(caret)caret.textContent=opening?'â–¼':'â–¶';});});
  CAT_ORDER.forEach(cat=>{const slug=cat.replace(/\s+/g,'-').toLowerCase();wireRangeBar(`range-${slug}`);});}
function drawCategory(chartId){const slug=chartId.replace('chart-','');const proper=CAT_ORDER.find(c=>c.replace(/\s+/g,'-').toLowerCase()===slug);if(!proper)return;const s=BY_CAT[proper]||[];const x=DATA_KEYS;const ticktext=monthLabelsFromMonthly(MONTHLY);const bars={x,y:s.map(r=>r.Quantidade),...barCfg(getComputedStyle(document.documentElement).getPropertyValue('--blue')||'#1e88e5'),name:'Quantidade (un.)',yaxis:'y2',hovertemplate:'<b>Quantidade:</b> %{customdata.q}<extra></extra>',customdata:s.map(r=>({q:Math.round(r.Quantidade).toLocaleString('pt-BR')}))};const line={x,y:s.map(r=>r.Valor),...lineCfg(getComputedStyle(document.documentElement).getPropertyValue('--orange')||'#fb8c00'),name:'Valor (R$)',yaxis:'y',hovertemplate:'<b>Valor:</b> %{customdata.v}<extra></extra>',customdata:s.map(r=>({v:fmtBRL(r.Valor)}))};const layout=baseLayoutCategory(x,ticktext,'Valor (R$)','Quantidade (un.)');Plotly.newPlot(chartId,[bars,line],layout,{responsive:true});const m=computeMetrics(s,'Valor');document.getElementById(`var-${slug}`).textContent=m.var;document.getElementById(`med-${slug}`).textContent=m.med;document.getElementById(`vol-${slug}`).textContent=m.vol;}

// ---- Boot ----
async function init(){
  try{
    const url=new URL('data/relatorio_faturamento.csv',location.href).toString();
    const res=await fetch(url+'?v='+Date.now(),{cache:'no-store'});if(!res.ok)throw new Error('CSV nÃ£o encontrado');
    const text=await res.text();const delimiter=detectDelimiter(text);const parsed=Papa.parse(text,{header:true,skipEmptyLines:true,delimiter});
    RAW=normalizeRows(parsed.data);
    const monthly=aggMonthly(RAW);MONTHLY=monthly;DATA_KEYS=monthly.map(m=>m.Key);DATA_MIN_KEY=DATA_KEYS[0];DATA_MAX_KEY=DATA_KEYS[DATA_KEYS.length-1];
    const bycat=aggMonthlyByCat(RAW,DATA_KEYS);BY_CAT=bycat.table;const MAIN=["CorrediÃ§a Oculta","CorrediÃ§a TelescÃ³pica","DobradiÃ§as","Articuladores","RodÃ­zio","Pulsadores"];const others=bycat.cats.filter(c=>!MAIN.includes(c)&&c!=="AcessÃ³rios");CAT_ORDER=[...MAIN.filter(c=>bycat.cats.includes(c)),...(bycat.cats.includes('AcessÃ³rios')?["AcessÃ³rios"]:[]),...others];
    const last=MONTHLY[MONTHLY.length-1];document.getElementById('updated').textContent='Atualizado: '+PT_ABBR[last.Mes-1]+'/'+last.Ano;

    drawTotal();
    drawRevenue();
    drawVolume();
    drawShare(false);
    buildCategoryCards();
    ['range-total','range-fatlin','range-vollin','range-share'].forEach(wireRangeBar);
  }catch(e){console.error(e);document.querySelector('.loading-text').textContent='Erro ao carregar dados (ver console).';}
  setTimeout(()=>document.getElementById('loading-overlay').classList.add('hidden'),200);
}
addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
