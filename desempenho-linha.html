<script>
function init(){
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    // âœ… Auto-detect tab or comma separator
    beforeFirstChunk: function(chunk){
      const firstLine = chunk.split(/\r?\n/)[0];
      if (firstLine.includes("\t")) this.delimiter = "\t";
      else this.delimiter = ",";
      return chunk;
    },
    complete: (res)=>{
      const rows = res.data || [];
      rawRows = normalizeRows(rows);
      if (!rawRows.length){
        document.getElementById("cats-container").innerHTML = "<p>CSV sem dados.</p>";
        return;
      }

      monthKeys = computeMonthKeys(rawRows);
      minKey = monthKeys[0];
      maxKey = monthKeys[monthKeys.length-1];

      populatePeriodSelectors();
      buildCategoryCards("cats-container", CATEGORIES);
      applyFiltersAndRender();
    },
    error: (err)=>{
      document.getElementById("cats-container").innerHTML = "<p>Erro ao carregar CSV.</p>";
      console.error(err);
    }
  });

  // events
  applyBtn.addEventListener("click", applyFiltersAndRender);
  metricSel.addEventListener("change", applyFiltersAndRender);
  window.addEventListener("resize", ()=>{
    document.querySelectorAll(".card-wrap").forEach(w=>{
      if (w.style.maxHeight && w.style.maxHeight !== "0px"){
        w.style.maxHeight = w.scrollHeight + "px";
      }
    });
  });
}

init();
</script>
