<!-- test.html | v1.2 | Strict categorical X (no Date) -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teste - VisÃ£o Geral (X categÃ³rico)</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<style>
  :root{--bg:#dfe1e1;--card:#fff;--red:#e53935;--blue:#1e88e5}
  body{margin:0;background:var(--bg);font-family:Inter,system-ui}
  .wrap{max-width:1000px;margin:40px auto;background:var(--card);padding:20px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.1)}
  #chart{width:100%;height:550px}
  #loading{position:fixed;inset:0;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;font-weight:600;z-index:10}
  #loading.hidden{opacity:0;pointer-events:none;transition:opacity .3s}
  pre{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:8px;border-radius:6px}
</style>
</head>
<body>
<div id="loading">Carregando dadosâ€¦</div>
<div class="wrap">
  <h2>ðŸ“Š VisÃ£o Geral (Valor e Quantidade)</h2>
  <div id="chart"></div>
  <h3>Debug</h3>
  <pre id="debug"></pre>
</div>

<script>
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];

function normalizeRows(rows){
  const out=[];
  for(const o of rows){
    const ano = Number(o.Ano);
    const mes = Number(o.Mes);
    if(!Number.isFinite(ano) || !Number.isFinite(mes) || mes<1 || mes>12) continue;
    out.push({
      Ano:ano,
      Mes:mes,
      Valor:Number(o.Valor)||0,
      Quantidade:Number(o.Quantidade)||0,
      Key:`${ano}-${String(mes).padStart(2,"0")}` // <- categorical key
    });
  }
  // sort by Key lexicographically -> chronological for YYYY-MM
  out.sort((a,b)=> a.Key.localeCompare(b.Key));
  // keep only last 10 years from newest
  if(out.length){
    const maxYear = out[out.length-1].Ano;
    const minAllowed = maxYear - 10;
    return out.filter(r=> r.Ano>=minAllowed && r.Ano<=maxYear);
  }
  return out;
}

function aggMonthly(rows){
  const map = new Map(); // Key -> {Key, Valor, Quantidade}
  for(const r of rows){
    if(!map.has(r.Key)) map.set(r.Key, {Key:r.Key, Valor:0, Quantidade:0, Ano:r.Ano, Mes:r.Mes});
    const m = map.get(r.Key);
    m.Valor += r.Valor;
    m.Quantidade += r.Quantidade;
  }
  return [...map.values()].sort((a,b)=> a.Key.localeCompare(b.Key));
}

function fmtBRL(v){ return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}); }
function fmtInt(v){ return Math.round(v).toLocaleString("pt-BR"); }

function drawTotal(monthly){
  if(!monthly.length){ document.getElementById('debug').textContent += "\nNenhum dado apÃ³s normalizaÃ§Ã£o."; return; }

  // X as strict categories
  const x = monthly.map(m=>m.Key);                     // ["2025-01","2025-02",...]
  const ticktext = monthly.map(m=> PT_ABBR[m.Mes-1]+" "+String(m.Ano).slice(-2)); // ["JAN 25",...]

  // Debug dump
  const dbg = [
    `First 3 keys: ${x.slice(0,3).join(", ")}`,
    `Last 3 keys:  ${x.slice(-3).join(", ")}`,
    `Ticktext:     ${ticktext.slice(0,3).join(", ")} ... ${ticktext.slice(-3).join(", ")}`
  ].join("\n");
  console.log(dbg);
  document.getElementById('debug').textContent += "\n"+dbg+"\n";

  const barsValor = {
    x, y: monthly.map(m=>m.Valor),
    type: 'bar',
    marker:{color:'var(--red)', opacity:0.85},
    name: 'Valor (R$)',
    hovertemplate: "<b>Valor:</b> %{customdata.v}<extra></extra>",
    customdata: monthly.map(m=>({v:fmtBRL(m.Valor)}))
  };

  const lineQtd = {
    x, y: monthly.map(m=>m.Quantidade),
    mode:'lines+markers',
    line:{shape:'spline', width:3, color:'var(--blue)', smoothing:0.6},
    marker:{size:6, line:{width:1, color:'#fff'}},
    name:'Quantidade (un.)',
    yaxis:'y2',
    hovertemplate:"<b>Quantidade:</b> %{customdata.q} un<extra></extra>",
    customdata: monthly.map(m=>({q:fmtInt(m.Quantidade)}))
  };

  Plotly.newPlot('chart', [barsValor, lineQtd], {
    hovermode:'x unified',
    xaxis:{
      type:'category',                 // <- FORCE CATEGORY AXIS
      categoryorder:'array',
      categoryarray:x,                 // keep order exact
      tickmode:'array',
      tickvals:x,
      ticktext:ticktext,
      showgrid:false
    },
    yaxis:{
      title:'Valor (R$)',
      gridcolor:'#e9ecef'
    },
    yaxis2:{
      title:'Quantidade (un.)',
      overlaying:'y',
      side:'right'
    },
    legend:{orientation:'h', y:-0.25},
    paper_bgcolor:'#fff',
    plot_bgcolor:'#fff',
    margin:{t:30,r:40,b:80,l:60}
  }, {responsive:true});
}

(async()=>{
  try{
    // add cache buster just in case
    const res = await fetch('data/relatorio_faturamento.csv?cb=' + Date.now());
    const text = await res.text();

    // auto-detect delimiter
    const delim = text.includes(';') ? ';' : ',';
    document.getElementById('debug').textContent = `Delimiter: "${delim}"`;
    const parsed = Papa.parse(text, {header:true, skipEmptyLines:true, delimiter:delim});

    const rows = normalizeRows(parsed.data);
    document.getElementById('debug').textContent += `\nRows after normalize: ${rows.length}`;
    const monthly = aggMonthly(rows);
    document.getElementById('debug').textContent += `\nMonthly points: ${monthly.length}`;

    drawTotal(monthly);
  } catch(err){
    console.error(err);
    document.getElementById('debug').textContent += `\nERROR: ${err}`;
  } finally {
    document.getElementById('loading').classList.add('hidden');
  }
})();
</script>
</body>
</html>
