<!-- test.html | v1.0 | VisÃ£o Geral Debug | Â© Cesar Beninatto -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Teste - VisÃ£o Geral</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<style>
  :root{
    --bg:#dfe1e1;--card:#fff;--text:#000;--accent:#f5b95f;
    --red:#e53935;--blue:#1e88e5;
  }
  body{margin:0;background:var(--bg);font-family:Inter,system-ui}
  .wrap{max-width:1000px;margin:40px auto;background:var(--card);
        padding:20px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.1);}
  h2{text-align:center;margin-bottom:10px}
  #chart{width:100%;height:550px}
  #loading{
    position:fixed;inset:0;background:rgba(255,255,255,.9);
    display:flex;align-items:center;justify-content:center;
    font-weight:600;font-size:1.2rem;color:#000;z-index:9999;
    transition:opacity .4s ease;
  }
  #loading.hidden{opacity:0;pointer-events:none;}
</style>
</head>
<body>
<div id="loading">Carregando dadosâ€¦</div>
<div class="wrap">
  <h2>ðŸ“Š VisÃ£o Geral (Valor e Quantidade)</h2>
  <div id="chart"></div>
</div>

<script>
const PT_ABBR=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];

function normalizeRows(rows){
  const out=[];
  rows.forEach(o=>{
    const ano=parseInt(o.Ano||o.ano,10);
    const mes=parseInt(o.Mes||o.mes,10);
    if(!ano||!mes) return;
    out.push({
      Ano:ano,
      Mes:mes,
      Valor:Number(o.Valor)||0,
      Quantidade:Number(o.Quantidade)||0,
      Data:new Date(Date.UTC(ano,mes-1,1)) // âœ… UTC safe
    });
  });
  out.sort((a,b)=>a.Data-b.Data);
  return out;
}

function aggMonthly(rows){
  const map=new Map();
  rows.forEach(r=>{
    const key=`${r.Ano}-${String(r.Mes).padStart(2,"0")}`;
    if(!map.has(key))
      map.set(key,{Data:new Date(Date.UTC(r.Ano,r.Mes-1,1)),Valor:0,Quantidade:0});
    const m=map.get(key);
    m.Valor+=(Number(r.Valor)||0);
    m.Quantidade+=(Number(r.Quantidade)||0);
  });
  return Array.from(map.values()).sort((a,b)=>a.Data-b.Data);
}

function fmtBRL(v){
  return v.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}
function fmtInt(v){return Math.round(v).toLocaleString("pt-BR");}

function drawTotal(monthly){
  if(!monthly.length){alert("Nenhum dado vÃ¡lido encontrado");return;}
  const x=monthly.map(r=>r.Data.toISOString().slice(0,10));
  const tickvals=[],ticktext=[];
  monthly.forEach(r=>{
    tickvals.push(r.Data.toISOString().slice(0,10));
    ticktext.push(PT_ABBR[r.Data.getUTCMonth()]+" "+String(r.Data.getUTCFullYear()).slice(-2));
  });
  const bars={
    x,y:monthly.map(r=>r.Valor),type:"bar",
    marker:{color:"var(--red)",opacity:0.8},name:"Valor (R$)",
    hovertemplate:"<b>Valor:</b> %{customdata.v}<extra></extra>",
    customdata:monthly.map(r=>({v:fmtBRL(r.Valor)}))
  };
  const line={
    x,y:monthly.map(r=>r.Quantidade),mode:"lines+markers",
    line:{shape:"spline",width:3,color:"var(--blue)",smoothing:0.6},
    marker:{size:6,line:{width:1,color:"#fff"}},
    name:"Quantidade (un.)",yaxis:"y2",
    hovertemplate:"<b>Quantidade:</b> %{customdata.q} un<extra></extra>",
    customdata:monthly.map(r=>({q:fmtInt(r.Quantidade)}))
  };
  const layout={
    hovermode:"x unified",
    xaxis:{tickmode:"array",tickvals,ticktext,showgrid:false,automargin:true},
    yaxis:{title:"Valor (R$)",tickformat:".2s",range:[0,5000000],
           dtick:1000000,tickprefix:"R$",gridcolor:"#e9ecef"},
    yaxis2:{title:"Quantidade (un.)",overlaying:"y",side:"right"},
    legend:{orientation:"h",y:-0.25},paper_bgcolor:"#fff",plot_bgcolor:"#fff",
    margin:{t:30,r:40,b:80,l:60}
  };
  Plotly.newPlot("chart",[bars,line],layout,{responsive:true});
}

(async()=>{
  try{
    const res=await fetch("data/relatorio_faturamento.csv");
    const text=await res.text();
    const parsed=Papa.parse(text,{header:true,skipEmptyLines:true});
    const rows=normalizeRows(parsed.data);
    const monthly=aggMonthly(rows);
    drawTotal(monthly);
  }catch(err){
    console.error(err);alert("Erro ao carregar dados");
  }finally{
    document.getElementById("loading").classList.add("hidden");
  }
})();
</script>
</body>
</html>
